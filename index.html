<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå | PEA Asset Cloud</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* --- MODERN PEA THEME --- */
        :root { 
            --p-main: #720e9e; 
            --p-grad-1: linear-gradient(135deg, #720e9e 0%, #9d46c1 100%);
            --bg-color: #f4f6f9;
        }
        body { 
            font-family: 'Kanit', sans-serif; 
            background: var(--bg-color); 
            color: #495057; 
            -webkit-font-smoothing: antialiased;
        }
        .hidden { display: none !important; }

        /* Modern Cards */
        .card-modern {
            background: white;
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-modern:active { transform: scale(0.98); }

        /* Login Screen */
        .auth-bg { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: white;
            background-image: radial-gradient(#720e9e10 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .auth-card { width: 100%; max-width: 420px; padding: 40px; text-align: center; }
        .form-control-modern {
            background: #f8f9fa; border: 1px solid transparent;
            padding: 15px; border-radius: 12px; font-size: 1rem;
            transition: all 0.3s;
        }
        .form-control-modern:focus {
            background: white; border-color: #720e9e50;
            box-shadow: 0 0 0 4px rgba(114, 14, 158, 0.1);
        }

        /* Dashboard Stats (‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô) */
        .stat-card {
            border-radius: 16px;
            padding: 15px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px -5px rgba(0,0,0,0.15);
        }
        .stat-card h2 { font-weight: 600; font-size: 2.2rem; margin-bottom: 0; line-height: 1; }
        .stat-card small { opacity: 0.9; font-weight: 400; font-size: 0.85rem; }
        .stat-card i { position: absolute; right: -10px; bottom: -10px; font-size: 3.5rem; opacity: 0.2; transform: rotate(-15deg); }
        
        .bg-grad-purple { background: linear-gradient(135deg, #720e9e 0%, #b06ab3 100%); }
        .bg-grad-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .bg-grad-orange { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); color: #fff; }

        /* Category Chips (‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô) */
        .chip-container { 
            overflow-x: auto; white-space: nowrap; 
            padding: 5px 2px 15px 2px;
            -ms-overflow-style: none; scrollbar-width: none; 
        }
        .chip-container::-webkit-scrollbar { display: none; }
        .chip-btn { 
            border: 1px solid #e9ecef; background: white; color: #6c757d; 
            border-radius: 50px; padding: 8px 18px; font-size: 0.9rem; 
            margin-right: 8px; transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .chip-btn.active { 
            background: var(--p-main); color: white; border-color: var(--p-main); 
            box-shadow: 0 4px 12px rgba(114, 14, 158, 0.3); transform: translateY(-1px);
        }

        /* Item Grid (‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤) */
        .item-card { 
            background: white; border-radius: 18px; padding: 15px;
            position: relative; border: 1px solid rgba(0,0,0,0.03);
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .item-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(114, 14, 158, 0.1); }
        .item-icon {
            width: 55px; height: 55px; border-radius: 14px;
            background: #f8f0fc; color: var(--p-main);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; margin-right: 15px;
        }
        .item-status-dot {
            width: 10px; height: 10px; border-radius: 50%;
            position: absolute; top: 15px; right: 15px;
        }
        
        /* Floating Navbar */
        .nav-float {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 15px 0; position: sticky; top: 0; z-index: 100;
        }

        /* Button Main */
        .btn-main {
            background: var(--p-grad-1); border: none; color: white;
            border-radius: 12px; padding: 12px; font-weight: 500;
            box-shadow: 0 4px 15px rgba(114, 14, 158, 0.25);
            transition: all 0.3s;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(114, 14, 158, 0.35); color: white; }

    </style>
</head>
<body>

    <div id="page-login" class="auth-bg">
        <div class="auth-card">
            <div class="mb-4">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/PEA_LOGO.png/600px-PEA_LOGO.png" width="80" alt="PEA Logo" style="filter: drop-shadow(0 5px 10px rgba(114,14,158,0.2));">
            </div>
            <h3 class="fw-bold mb-1" style="color: var(--p-main);">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <p class="text-muted mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå PEA Asset</p>
            
            <div class="text-start d-flex flex-column gap-3">
                <input type="email" id="login-email" class="form-control-modern" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (user@pea.co.th)">
                <input type="password" id="login-pass" class="form-control-modern" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            </div>

            <button class="btn-main w-100 mt-4" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</button>
            
            <div class="mt-4 pt-3">
                <button class="btn btn-link text-decoration-none text-muted p-0" onclick="goRegister()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button>
            </div>
            <div id="login-msg" class="text-danger small mt-3 fw-bold"></div>
        </div>
    </div>

    <div id="page-register" class="auth-bg hidden">
        <div class="auth-card py-4" style="max-width: 600px;">
            <div class="text-start mb-4">
                <button class="btn btn-light btn-sm rounded-circle shadow-sm" onclick="goLogin()"><i class="bi bi-arrow-left"></i></button>
                <span class="fw-bold ms-3 fs-5">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>
            </div>

            <div class="row g-3 text-start">
                <div class="col-md-6"><input type="text" id="reg-name" class="form-control-modern" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
                <div class="col-md-6"><input type="tel" id="reg-phone" class="form-control-modern" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"></div>
                <div class="col-12">
                    <select id="reg-branch" class="form-control-modern">
                        <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î --</option>
                        <optgroup label="üè¢ ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï ‡∏Å‡∏ü‡∏ï.1 (‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ)"><option value="‡∏Å‡∏ü‡∏ï.1">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï ‡∏Å‡∏ü‡∏ï.1</option></optgroup>
                        <optgroup label="üìç ‡∏à.‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ">
                            <option value="‡∏Å‡∏ü‡∏à.‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ">‡∏Å‡∏ü‡∏à.‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ</option><option value="‡∏Å‡∏ü‡∏≠.‡∏ä‡∏∞‡∏≠‡∏≥">‡∏Å‡∏ü‡∏≠.‡∏ä‡∏∞‡∏≠‡∏≥</option><option value="‡∏Å‡∏ü‡∏≠.‡∏ó‡πà‡∏≤‡∏¢‡∏≤‡∏á">‡∏Å‡∏ü‡∏≠.‡∏ó‡πà‡∏≤‡∏¢‡∏≤‡∏á</option>
                            <option value="‡∏Å‡∏ü‡∏≠.‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡∏≤‡∏î">‡∏Å‡∏ü‡∏≠.‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡∏≤‡∏î</option><option value="‡∏Å‡∏ü‡∏≠.‡πÄ‡∏Ç‡∏≤‡∏¢‡πâ‡∏≠‡∏¢">‡∏Å‡∏ü‡∏≠.‡πÄ‡∏Ç‡∏≤‡∏¢‡πâ‡∏≠‡∏¢</option><option value="‡∏Å‡∏ü‡∏≠.‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏´‡∏•‡∏°">‡∏Å‡∏ü‡∏≠.‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏´‡∏•‡∏°</option>
                            <option value="‡∏Å‡∏ü‡∏™‡∏≤‡∏Ç‡∏≤.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡∏õ‡∏•‡πâ‡∏≠‡∏á">‡∏Å‡∏ü‡∏™‡∏≤‡∏Ç‡∏≤.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡∏õ‡∏•‡πâ‡∏≠‡∏á</option><option value="‡∏Å‡∏ü‡∏™‡∏≤‡∏Ç‡∏≤.‡πÅ‡∏Å‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏ô">‡∏Å‡∏ü‡∏™‡∏≤‡∏Ç‡∏≤.‡πÅ‡∏Å‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏ô</option>
                        </optgroup>
                    </select>
                </div>
                <div class="col-12">
                    <select id="reg-dept" class="form-control-modern">
                        <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
                        <option value="‡∏ú‡∏à‡∏Å.">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏ú‡∏à‡∏Å.)</option><option value="‡∏Å‡∏≠‡∏Å.">‡∏Å‡∏≠‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Å‡∏≠‡∏Å.)</option>
                        <option value="‡∏Å‡∏ö‡∏á.">‡∏Å‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (‡∏Å‡∏ö‡∏á.)</option><option value="‡∏Å‡∏ö‡∏Ñ.">‡∏Å‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏Å‡∏ö‡∏Ñ.)</option>
                        <option value="‡∏Å‡∏ß‡∏ú.">‡∏Å‡∏≠‡∏á‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (‡∏Å‡∏ß‡∏ú.)</option><option value="‡∏Å‡∏õ‡∏ö.">‡∏Å‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ (‡∏Å‡∏õ‡∏ö.)</option>
                        <option value="‡∏Å‡∏ö‡∏•.">‡∏Å‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Å‡∏ö‡∏•.)</option><option value="‡∏Å‡∏Ñ‡∏™.">‡∏Å‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏Å‡∏Ñ‡∏™.)</option>
                        <option value="‡∏Å‡∏û‡∏´.">‡∏Å‡∏≠‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏ (‡∏Å‡∏û‡∏´.)</option><option value="‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå">‡πÅ‡∏ú‡∏ô‡∏Å‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå</option>
                        <option value="‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏">‡∏Ñ‡∏•‡∏±‡∏á‡∏û‡∏±‡∏™‡∏î‡∏∏</option><option value="‡πÑ‡∏≠‡∏ó‡∏µ/‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£">‡πÑ‡∏≠‡∏ó‡∏µ / ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</option>
                    </select>
                </div>
                <div class="col-12"><input type="email" id="reg-email" class="form-control-modern" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö)"></div>
                <div class="col-12"><input type="password" id="reg-pass" class="form-control-modern" placeholder="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"></div>
            </div>

            <button class="btn-main w-100 mt-4" onclick="doRegister()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>
    </div>

    <div id="page-main" class="hidden">
        <div class="nav-float shadow-sm mb-4">
            <div class="container d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="bg-grad-purple text-white rounded-circle d-flex align-items-center justify-content-center fw-bold me-2" style="width: 35px; height: 35px;">P</div>
                    <div>
                        <h6 class="fw-bold mb-0 text-dark">PEA Asset</h6>
                        <small class="text-muted" style="font-size: 0.7rem;" id="nav-info">Loading...</small>
                    </div>
                </div>
                <button class="btn btn-light btn-sm rounded-pill text-danger px-3" onclick="logout()"><i class="bi bi-box-arrow-right"></i></button>
            </div>
        </div>

        <div class="container pb-5">
            <div id="db-status" class="alert alert-light border small py-1 mb-3 text-center text-muted rounded-pill bg-white shadow-sm" style="font-size: 0.75rem;">
                <span class="spinner-border spinner-border-sm me-2"></span>Connecting to Database...
            </div>

            <div class="row g-3 mb-4">
                <div class="col-4">
                    <div class="stat-card bg-grad-purple">
                        <h2 id="stat-total">0</h2>
                        <small>‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                        <i class="bi bi-box-seam"></i>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card bg-grad-green">
                        <h2 id="stat-avail">0</h2>
                        <small>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏á</small>
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card bg-grad-orange">
                        <h2 id="stat-borrow">0</h2>
                        <small>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</small>
                        <i class="bi bi-clock-history"></i>
                    </div>
                </div>
            </div>

            <div class="chip-container mb-3 ps-1">
                <button class="chip-btn active" onclick="selectCategory('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="chip-btn" onclick="selectCategory('bi-laptop', this)">üíª ‡∏Ñ‡∏≠‡∏°/‡πÑ‡∏≠‡∏ó‡∏µ</button>
                <button class="chip-btn" onclick="selectCategory('bi-broadcast', this)">üìª ‡∏ß‡∏¥‡∏ó‡∏¢‡∏∏</button>
                <button class="chip-btn" onclick="selectCategory('bi-tools', this)">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</button>
                <button class="chip-btn" onclick="selectCategory('bi-car-front', this)">üöó ‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</button>
                <button class="chip-btn" onclick="selectCategory('bi-printer', this)">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
            </div>

            <div class="d-flex gap-2 mb-4">
                <div class="input-group shadow-sm bg-white rounded-pill overflow-hidden border-0">
                    <span class="input-group-text bg-white border-0 ps-3"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" id="search-box" class="form-control border-0 shadow-none" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå..." onkeyup="renderGrid()">
                    <button class="btn btn-light border-0 text-muted border-start" id="btn-my-items" onclick="toggleMyFilter()">
                        <i class="bi bi-person-circle"></i> ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                    </button>
                    <button class="btn btn-light border-0 text-primary px-3" onclick="openScanner()"><i class="bi bi-qr-code-scan"></i></button>
                </div>
                <button id="btn-add-item" class="btn btn-main px-3 shadow-sm hidden rounded-circle" onclick="openAddModal()" style="width: 45px; height: 45px; flex-shrink: 0;">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>

            <div id="items-grid" class="row g-3 mb-5"></div>
            
            <h6 class="fw-bold text-muted ps-2 border-start border-4 border-primary mt-5">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
            <div id="history-list" class="list-group list-group-flush bg-white rounded-4 shadow-sm p-2 mt-3"></div>
        </div>
    </div>

    <div id="asset-detail" class="bg-white p-4 hidden shadow-lg position-fixed bottom-0 start-0 w-100 m-0 rounded-top-4" style="z-index: 1050; max-height: 85vh; overflow-y: auto; transition: transform 0.3s;">
        <div class="text-center mb-4"><div class="bg-secondary rounded-pill mx-auto" style="width: 40px; height: 4px; opacity: 0.2;"></div></div>
        <div class="d-flex align-items-start mb-4">
            <div class="bg-light rounded-3 p-3 me-3 text-primary"><i class="bi bi-box-seam fs-1"></i></div>
            <div>
                <span class="badge bg-secondary mb-1 fw-normal" id="det-id">ID</span>
                <h4 class="fw-bold mb-0 text-dark" id="det-name">Item Name</h4>
            </div>
        </div>
        <div id="status-area"></div>
        <button class="btn btn-light text-muted w-100 mt-3 rounded-pill" onclick="closeAssetDetail()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        <div id="admin-tools" class="mt-3 pt-3 border-top hidden text-center">
            <button class="btn btn-sm text-danger" onclick="deleteItem()"><i class="bi bi-trash"></i> ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ (Admin)</button>
        </div>
    </div>

    <div class="modal fade" id="scannerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 overflow-hidden">
                <div class="modal-body p-0"><div id="reader"></div></div>
                <button class="btn btn-light w-100 rounded-0 py-3 fw-bold" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 p-3">
                <div class="modal-header border-0"><h5 class="modal-title fw-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÉ‡∏´‡∏°‡πà</h5></div>
                <div class="modal-body pt-0">
                    <input id="new-id" class="form-control-modern mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô/Serial No.">
                    <input id="new-name" class="form-control-modern mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
                    <select id="new-icon" class="form-control-modern">
                        <option value="bi-broadcast">‡∏ß‡∏¥‡∏ó‡∏¢‡∏∏‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</option>
                        <option value="bi-laptop">‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå/Notebook</option>
                        <option value="bi-tools">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á</option>
                        <option value="bi-car-front">‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</option>
                        <option value="bi-printer">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</option>
                    </select>
                </div>
                <div class="modal-footer border-0"><button class="btn-main w-100" onclick="confirmAddItem()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="borrowModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 p-3">
                <div class="modal-header border-0"><h5 class="modal-title fw-bold">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</h5></div>
                <div class="modal-body text-center pt-0">
                    <input type="text" id="due-date-input" class="form-control border-0 bg-light text-center fw-bold text-primary display-6 py-4 rounded-4" placeholder="‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ" onfocus="(this.type='date')" onblur="if(!this.value) { this.type='text'; }">
                </div>
                <div class="modal-footer border-0"><button class="btn-main w-100" onclick="confirmBorrow()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</button></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, push, remove, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDHBp7xoh9TgIxIkbfv3ZGe-z8isnSJo1Q",
            authDomain: "pea-asset-realtime.firebaseapp.com",
            databaseURL: "https://pea-asset-realtime-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pea-asset-realtime",
            storageBucket: "pea-asset-realtime.firebasestorage.app",
            messagingSenderId: "1097630363105",
            appId: "1:1097630363105:web:08d18ed117a8c9de5bf6a0"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Export globals
        window.db = db; window.dbRef = ref; window.dbSet = set; window.dbUpdate = update;
        window.dbPush = push; window.dbRemove = remove; window.dbGet = get; window.dbChild = child;

        // Listener
        onValue(ref(db, 'items'), (snapshot) => {
            document.getElementById('db-status').innerHTML = '<span class="text-success">‚óè</span> Online';
            
            const data = snapshot.val();
            window.allItems = data ? Object.values(data) : [];
            window.renderGrid();
            
            if(window.currentOpenId) {
                const item = window.allItems.find(i => i.id === window.currentOpenId);
                item ? window.renderDetailContent(item) : window.closeAssetDetail();
            }
        });

        onValue(ref(db, 'logs'), (snapshot) => {
            const data = snapshot.val();
            const logs = data ? Object.values(data).reverse().slice(0, 15) : [];
            document.getElementById('history-list').innerHTML = logs.map(l => `
                <div class="list-group-item border-0 border-bottom py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" style="width:35px; height:35px">
                                <i class="bi ${l.action==='‡∏¢‡∏∑‡∏°'?'bi-arrow-up-right text-warning':'bi-arrow-down-left text-success'}"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold text-dark">${l.item}</h6>
                                <small class="text-muted"><i class="bi bi-person"></i> ${l.user}</small>
                            </div>
                        </div>
                        <small class="text-muted text-end" style="font-size:0.7rem">${l.time}</small>
                    </div>
                </div>`).join('');
        });
    </script>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxwRwxPPltqI0w0CO6KafoSo0uMF4jqoXtqRioVUL4w0_YJhBC01cBMJDZGsmizkFpnCA/exec";
        
        window.allItems = [];
        window.currentOpenId = null;
        window.showMyFilter = false;
        window.currentCategory = 'all';

        let currentUser = JSON.parse(localStorage.getItem('pea_user_session'));
        const ADMIN_EMAILS = ["admin@pea.co.th", "tewit2547t@gmail.com"];

        window.onload = function() {
            document.getElementById('scannerModal').addEventListener('hidden.bs.modal', () => { if(html5QrcodeScanner) html5QrcodeScanner.clear(); });
            currentUser ? showMain() : goLogin();
        };

        function formatDateToThai(dateString) {
            if (!dateString) return "-";
            const p = dateString.split('-');
            return p.length === 3 ? `${p[2]}/${p[1]}/${p[0]}` : dateString;
        }

        // --- AUTH ---
        window.goLogin = () => { hideAll(); document.getElementById('page-login').classList.remove('hidden'); }
        window.goRegister = () => { hideAll(); document.getElementById('page-register').classList.remove('hidden'); }
        function hideAll() { document.querySelectorAll('#page-login, #page-register, #page-main').forEach(el => el.classList.add('hidden')); }

        window.doRegister = function() {
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const branch = document.getElementById('reg-branch').value;
            const dept = document.getElementById('reg-dept').value;
            const email = document.getElementById('reg-email').value.trim().toLowerCase();
            const pass = document.getElementById('reg-pass').value;

            if(!name || !phone || !branch || !dept || !email || !pass) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

            const dbRef = window.dbRef(window.db);
            window.dbGet(window.dbChild(dbRef, 'users')).then((snapshot) => {
                const users = snapshot.val() || {};
                if(Object.values(users).some(u => u.email === email)) return alert("‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß");
                const newUser = { name, phone, branch, dept, email, pass };
                window.dbPush(window.dbRef(window.db, 'users'), newUser).then(() => {
                    alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); currentUser = newUser;
                    localStorage.setItem('pea_user_session', JSON.stringify(currentUser)); showMain();
                });
            });
        }

        window.doLogin = function() {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) return;

            window.dbGet(window.dbChild(window.dbRef(window.db), 'users')).then((snapshot) => {
                const users = snapshot.val();
                let foundUser = Object.values(users || {}).find(u => u.email === email && u.pass === pass);
                if(!foundUser && ADMIN_EMAILS.includes(email) && pass === "admin1234") 
                    foundUser = { name: "Admin System", email: email, branch: "‡∏Å‡∏ü‡∏ï.1", dept: "Admin", phone: "-" };

                if(foundUser) {
                    currentUser = foundUser; localStorage.setItem('pea_user_session', JSON.stringify(currentUser)); showMain();
                } else document.getElementById('login-msg').innerText = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
            });
        }

        window.logout = () => { localStorage.removeItem('pea_user_session'); location.reload(); }

        window.showMain = () => {
            hideAll(); document.getElementById('page-main').classList.remove('hidden');
            // document.getElementById('nav-user').innerText = currentUser.name.split(' ')[0]; // Show first name only
            document.getElementById('nav-info').innerText = `${currentUser.branch}`;
            if(ADMIN_EMAILS.includes(currentUser.email)) document.getElementById('btn-add-item').classList.remove('hidden');
        }

        // --- FILTER & RENDER ---
        window.selectCategory = function(cat, btn) {
            window.currentCategory = cat;
            document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.renderGrid();
        }

        window.toggleMyFilter = function() {
            window.showMyFilter = !window.showMyFilter;
            const btn = document.getElementById('btn-my-items');
            if(window.showMyFilter) {
                btn.classList.remove('text-muted');
                btn.classList.add('text-primary', 'fw-bold', 'bg-light');
            } else {
                btn.classList.remove('text-primary', 'fw-bold', 'bg-light');
                btn.classList.add('text-muted');
            }
            window.renderGrid();
        }

        window.renderGrid = function() {
            const txt = document.getElementById('search-box').value.toLowerCase();
            const grid = document.getElementById('items-grid');
            grid.innerHTML = "";

            // Stats
            const total = window.allItems.length;
            const borrowedCount = window.allItems.filter(i => i.status === 'borrowed').length;
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-avail').innerText = total - borrowedCount;
            document.getElementById('stat-borrow').innerText = borrowedCount;

            let filtered = window.allItems.filter(i => i.name.toLowerCase().includes(txt) || i.id.toLowerCase().includes(txt));
            
            if(window.currentCategory !== 'all') filtered = filtered.filter(i => i.icon === window.currentCategory);
            if(window.showMyFilter) filtered = filtered.filter(i => i.status === 'borrowed' && i.borrower && i.borrower.email === currentUser.email);

            // Sort: Available first
            filtered.sort((a, b) => {
                if(a.status === 'available' && b.status !== 'available') return -1;
                if(a.status !== 'available' && b.status === 'available') return 1;
                return a.name.localeCompare(b.name);
            });

            if(filtered.length === 0) { grid.innerHTML = `<div class="col-12 text-center text-muted py-5 opacity-50"><i class="bi bi-inbox fs-1"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`; return; }

            filtered.forEach(item => {
                let isLate = false; let lateDays = 0;
                if(item.status === 'borrowed' && item.due_date) {
                    const due = new Date(item.due_date); due.setHours(0,0,0,0);
                    const today = new Date(); today.setHours(0,0,0,0);
                    if(today > due) { isLate = true; lateDays = Math.ceil((today - due) / (1000*60*60*24)); }
                }

                const statusDot = item.status === 'available' ? 'bg-success' : 'bg-warning';
                
                grid.innerHTML += `
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="item-card d-flex align-items-center" onclick="openDetail('${item.id}')">
                        <div class="item-status-dot ${statusDot}"></div>
                        <div class="item-icon"><i class="bi ${item.icon || 'bi-box-seam'}"></i></div>
                        <div style="flex:1; overflow:hidden;">
                            <h6 class="fw-bold mb-1 text-truncate text-dark">${item.name}</h6>
                            <small class="text-muted d-block">${item.id}</small>
                            ${isLate ? `<span class="badge bg-danger rounded-pill mt-1">‡πÄ‡∏Å‡∏¥‡∏ô ${lateDays} ‡∏ß‡∏±‡∏ô</span>` : ''}
                        </div>
                    </div>
                </div>`;
            });
        };

        // --- ACTIONS ---
        function sendToGoogleSheets(data) {
            if(!GOOGLE_SCRIPT_URL) return;
            if(data.phone) data.phone = "'" + data.phone; 
            fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) }).catch(console.error);
        }

        window.openDetail = (id) => { window.currentOpenId = id; const item = window.allItems.find(i => i.id === id); if(item) { document.getElementById('asset-detail').classList.remove('hidden'); window.renderDetailContent(item); } };

        window.renderDetailContent = (item) => {
            document.getElementById('det-name').innerText = item.name;
            document.getElementById('det-id').innerText = item.id;
            document.getElementById('admin-tools').classList.toggle('hidden', !ADMIN_EMAILS.includes(currentUser.email));
            
            const area = document.getElementById('status-area');
            if(item.status === 'available') {
                area.innerHTML = `<div class="p-3 bg-light rounded-4 mb-3 text-center text-success"><i class="bi bi-check-circle-fill fs-3 d-block mb-2"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</div><button class="btn-main w-100" onclick="openBorrowModal()">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</button>`;
            } else {
                const b = item.borrower || {};
                area.innerHTML = `
                    <div class="p-4 bg-light rounded-4 mb-3 border border-warning border-opacity-25">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center me-3" style="width:40px; height:40px; font-weight:bold">${b.name.charAt(0)}</div>
                            <div>
                                <h6 class="fw-bold mb-0">${b.name}</h6>
                                <small class="text-muted">${b.branch} (${b.dept})</small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between bg-white p-3 rounded-3 mb-2">
                            <small class="text-muted">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</small>
                            <strong class="text-danger">${formatDateToThai(item.due_date)}</strong>
                        </div>
                        <div class="d-flex justify-content-between bg-white p-3 rounded-3">
                            <small class="text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</small>
                            <strong>${b.phone}</strong>
                        </div>
                    </div>
                    ${(ADMIN_EMAILS.includes(currentUser.email) || b.email === currentUser.email) ? 
                        `<button class="btn btn-outline-danger w-100 rounded-pill py-2" onclick="doReturn()">‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á</button>` : `<button class="btn btn-secondary w-100 rounded-pill" disabled>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‡πÑ‡∏î‡πâ</button>`}
                `;
            }
        };

        window.closeAssetDetail = () => { document.getElementById('asset-detail').classList.add('hidden'); window.currentOpenId = null; };
        function openAddModal() { new bootstrap.Modal(document.getElementById('addModal')).show(); }
        
        window.confirmAddItem = () => {
            const id = document.getElementById('new-id').value;
            const name = document.getElementById('new-name').value;
            const icon = document.getElementById('new-icon').value;
            if(!id || !name) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            window.dbSet(window.dbRef(window.db, 'items/' + id), { id, name, icon, status: 'available' });
            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
        }

        window.deleteItem = () => {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
            window.dbRemove(window.dbRef(window.db, 'items/' + window.currentOpenId)); window.closeAssetDetail();
        }

        window.openBorrowModal = () => { document.getElementById('due-date-input').min = new Date().toISOString().split('T')[0]; new bootstrap.Modal(document.getElementById('borrowModal')).show(); }
        
        window.confirmBorrow = () => {
            const date = document.getElementById('due-date-input').value;
            if(!date) return alert('‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
            const item = window.allItems.find(i => i.id === window.currentOpenId);
            window.dbUpdate(window.dbRef(window.db, 'items/' + item.id), { status: 'borrowed', due_date: date, borrower: { name: currentUser.name, email: currentUser.email, branch: currentUser.branch, dept: currentUser.dept, phone: currentUser.phone } });
            window.dbPush(window.dbRef(window.db, 'logs'), { item: item.name, action: '‡∏¢‡∏∑‡∏°', user: currentUser.name, dept: currentUser.dept, time: new Date().toLocaleString('th-TH') });
            sendToGoogleSheets({ action: '‡∏¢‡∏∑‡∏°', itemName: item.name, itemId: item.id, userName: currentUser.name, branch: currentUser.branch + " (" + currentUser.dept + ")", email: currentUser.email, phone: currentUser.phone, dueDate: formatDateToThai(date), note: '-' });
            bootstrap.Modal.getInstance(document.getElementById('borrowModal')).hide();
        }

        window.doReturn = () => {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå?')) return;
            const item = window.allItems.find(i => i.id === window.currentOpenId);
            window.dbUpdate(window.dbRef(window.db, 'items/' + item.id), { status: 'available', due_date: null, borrower: null });
            window.dbPush(window.dbRef(window.db, 'logs'), { item: item.name, action: '‡∏Ñ‡∏∑‡∏ô', user: currentUser.name, dept: currentUser.dept, time: new Date().toLocaleString('th-TH') });
            sendToGoogleSheets({ action: '‡∏Ñ‡∏∑‡∏ô', itemName: item.name, itemId: item.id, userName: currentUser.name, branch: currentUser.branch + " (" + currentUser.dept + ")", email: currentUser.email, phone: currentUser.phone, dueDate: '-', note: '‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
        }

        let html5QrcodeScanner = null;
        window.openScanner = () => {
            const modal = new bootstrap.Modal(document.getElementById('scannerModal')); modal.show();
            setTimeout(() => { if(html5QrcodeScanner) html5QrcodeScanner.clear(); html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false); html5QrcodeScanner.render(window.onScanSuccess, ()=>{}); }, 500);
        }
        window.onScanSuccess = (txt) => {
            if(html5QrcodeScanner) html5QrcodeScanner.clear();
            bootstrap.Modal.getInstance(document.getElementById('scannerModal')).hide();
            document.getElementById('search-box').value = txt; window.renderGrid();
            const item = window.allItems.find(i => i.id === txt);
            item ? openDetail(item.id) : alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™: ' + txt);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>